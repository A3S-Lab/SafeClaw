# SafeClaw å¾®ä¿¡é£æ ¼å¤šä¼šè¯ UI è§„åˆ’

## ç°çŠ¶åˆ†æ

å½“å‰ UI å·²æœ‰ï¼š
- React 18 + TypeScript + Tailwind + shadcn/ui + Tauri v2
- Valtio çŠ¶æ€ç®¡ç†ï¼ˆagent.model.tsï¼‰
- WebSocket å®æ—¶é€šä¿¡ + REST API
- å¤šä¼šè¯ç®¡ç†ï¼ˆåˆ›å»º/åˆ é™¤/å½’æ¡£/é‡å‘½åï¼‰
- Virtuoso è™šæ‹Ÿæ»šåŠ¨æ¶ˆæ¯åˆ—è¡¨
- `react-nice-avatar` å·²å®‰è£…ï¼ˆv1.5.0ï¼‰ä½†æœªä½¿ç”¨

å½“å‰ç¼ºå¤±ï¼š
- æ— è§’è‰²/äººè®¾ï¼ˆPersonaï¼‰æ¦‚å¿µ â€” ä¼šè¯åªæœ‰ model + permission_mode
- æ— å¤´åƒæ˜¾ç¤º â€” æ¶ˆæ¯ä»…é å·¦å³å¯¹é½åŒºåˆ†
- ä¼šè¯åˆ—è¡¨æ— å¤´åƒã€æ— æœ€åæ¶ˆæ¯é¢„è§ˆ
- æ— å†…ç½®è§’è‰²æ¨¡æ¿

---

## æ•´ä½“è®¾è®¡

### æ ¸å¿ƒæ¦‚å¿µï¼šAgent Personaï¼ˆè§’è‰²äººè®¾ï¼‰

æ¯ä¸ªä¼šè¯ç»‘å®šä¸€ä¸ª Personaï¼ŒåŒ…å«ï¼š

```typescript
interface AgentPersona {
  id: string;                    // å”¯ä¸€æ ‡è¯†ï¼Œå†…ç½®è§’è‰²ç”¨å›ºå®š ID
  name: string;                  // æ˜¾ç¤ºåç§°ï¼Œå¦‚ "ç³»ç»Ÿç®¡ç†ä¸“å®¶"
  avatar: NiceAvatarConfig;      // react-nice-avatar é…ç½®
  systemPrompt: string;          // æ³¨å…¥åˆ°ä¼šè¯çš„ç³»ç»Ÿæç¤ºè¯
  description: string;           // è§’è‰²ç®€ä»‹
  isBuiltin: boolean;            // æ˜¯å¦å†…ç½®è§’è‰²
  model?: string;                // é»˜è®¤æ¨¡å‹ï¼ˆå¯é€‰è¦†ç›–ï¼‰
  permissionMode?: string;       // é»˜è®¤æƒé™æ¨¡å¼
}

// react-nice-avatar é…ç½®
interface NiceAvatarConfig {
  sex: "man" | "woman";
  faceColor: string;
  earSize: "small" | "big";
  hairColor: string;
  hairStyle: "normal" | "thick" | "mohawk" | "womanLong" | "womanShort";
  hatColor: string;
  hatStyle: "none" | "beanie" | "turban";
  eyeStyle: "circle" | "oval" | "smile";
  glassesStyle: "none" | "round" | "square";
  noseStyle: "short" | "long" | "round";
  mouthStyle: "laugh" | "smile" | "peace";
  shirtStyle: "hoody" | "short" | "polo";
  shirtColor: string;
  bgColor: string;
}
```

### å†…ç½®è§’è‰²

| ID | åç§° | å®šä½ | å¤´åƒé£æ ¼ |
|---|---|---|---|
| `sysadmin` | ç³»ç»Ÿç®¡ç†ä¸“å®¶ | Linux/DevOps/åŸºç¡€è®¾æ–½ | ç”·æ€§ï¼Œæˆ´çœ¼é•œï¼Œè¿å¸½è¡« |
| `finance` | é‡‘èä¸“å®¶ | è´¢åŠ¡åˆ†æ/æŠ•èµ„/é£æ§ | å¥³æ€§ï¼ŒèŒä¸šè£…ï¼ŒçŸ­å‘ |
| `legal` | æ³•åŠ¡ä¸“å®¶ | åˆåŒå®¡æŸ¥/åˆè§„/æ³•å¾‹å’¨è¯¢ | ç”·æ€§ï¼Œpoloè¡«ï¼Œåœ†çœ¼é•œ |
| `coder` | ç¼–ç¨‹åŠ©æ‰‹ | é€šç”¨ç¼–ç¨‹/ä»£ç å®¡æŸ¥ | ä¸­æ€§ï¼Œmohawkå‘å‹ï¼Œè¿å¸½è¡« |
| `writer` | å†™ä½œåŠ©æ‰‹ | æ–‡æ¡£/æŠ¥å‘Š/å†…å®¹åˆ›ä½œ | å¥³æ€§ï¼Œé•¿å‘ï¼Œå¾®ç¬‘ |
| `general` | é€šç”¨åŠ©æ‰‹ | é»˜è®¤è§’è‰²ï¼Œæ— ç‰¹å®šé¢†åŸŸ | ä¸­æ€§ï¼Œç®€æ´é£æ ¼ |

ç”¨æˆ·ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå®šä¹‰è§’è‰²ã€‚

---

## æ”¹åŠ¨èŒƒå›´

### Phase 1ï¼šæ•°æ®å±‚ â€” Persona æ¨¡å‹ä¸æŒä¹…åŒ–

**æ–°å¢æ–‡ä»¶ï¼š**

1. `src/typings/persona.ts` â€” Persona ç±»å‹å®šä¹‰
2. `src/models/persona.model.ts` â€” Persona çŠ¶æ€ç®¡ç†ï¼ˆValtioï¼‰
3. `src/lib/builtin-personas.ts` â€” å†…ç½®è§’è‰²å®šä¹‰

**æ”¹åŠ¨ï¼š**

4. `src/models/agent.model.ts` â€” æ–°å¢ `sessionPersonas: Record<sessionId, personaId>` å­—æ®µï¼Œå°†ä¼šè¯ä¸è§’è‰²å…³è”
5. `src/typings/agent.ts` â€” `AgentProcessInfo` æ‰©å±• `persona_id?: string` å­—æ®µ

**æŒä¹…åŒ–ç­–ç•¥ï¼š**
- å†…ç½®è§’è‰²ç¡¬ç¼–ç åœ¨å‰ç«¯
- è‡ªå®šä¹‰è§’è‰²å­˜ localStorageï¼ˆkey: `safeclaw-personas`ï¼‰
- ä¼šè¯-è§’è‰²æ˜ å°„å­˜ localStorageï¼ˆkey: `safeclaw-session-personas`ï¼‰
- åç»­å¯è¿ç§»åˆ°åç«¯ REST API

### Phase 2ï¼šä¼šè¯åˆ—è¡¨ â€” å¾®ä¿¡é£æ ¼æ”¹é€ 

**æ”¹åŠ¨æ–‡ä»¶ï¼š`src/pages/agent/components/agent-session-list.tsx`**

å½“å‰æ ·å¼ï¼š
```
[â—] ä¼šè¯ abc123de
    claude-sonnet Â· connected
```

æ”¹é€ ä¸ºå¾®ä¿¡é£æ ¼ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” æœç´¢                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Avatar] ç³»ç»Ÿç®¡ç†ä¸“å®¶    14:32â”‚
â”‚          æœ€è¿‘åœ¨è®¨è®º Docker... â”‚
â”‚                              â”‚
â”‚ [Avatar] é‡‘èä¸“å®¶        æ˜¨å¤© â”‚
â”‚          Q3 è´¢æŠ¥åˆ†æç»“æœ...   â”‚
â”‚                              â”‚
â”‚ [Avatar] ç¼–ç¨‹åŠ©æ‰‹       å‘¨ä¸€  â”‚
â”‚          å·²å®Œæˆä»£ç é‡æ„       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å…³é”®æ”¹åŠ¨ï¼š
- æ¯ä¸ªä¼šè¯é¡¹æ˜¾ç¤º `react-nice-avatar` å¤´åƒï¼ˆ48x48ï¼‰
- æ˜¾ç¤ºè§’è‰²åç§°ï¼ˆæ›¿ä»£ session_idï¼‰
- æ˜¾ç¤ºæœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆï¼ˆæˆªæ–­åˆ°ä¸€è¡Œï¼‰
- æ˜¾ç¤ºç›¸å¯¹æ—¶é—´ï¼ˆåˆšåˆš/14:32/æ˜¨å¤©/å‘¨ä¸€ï¼‰
- æœªè¯»æ¶ˆæ¯è®¡æ•°å¾½ç« ï¼ˆBadgeï¼‰
- åœ¨çº¿çŠ¶æ€æŒ‡ç¤ºå™¨å åŠ åœ¨å¤´åƒä¸Š
- é¡¶éƒ¨æœç´¢æ¡†ï¼ˆè¿‡æ»¤ä¼šè¯åç§°/è§’è‰²åï¼‰

### Phase 3ï¼šåˆ›å»ºä¼šè¯ â€” è§’è‰²é€‰æ‹©

**æ”¹åŠ¨æ–‡ä»¶ï¼š`src/pages/agent/components/create-session-dialog.tsx`**

å½“å‰æµç¨‹ï¼šé€‰æ¨¡å‹ â†’ é€‰æƒé™ â†’ å¡«ç›®å½• â†’ åˆ›å»º

æ”¹é€ ä¸ºä¸¤æ­¥æµç¨‹ï¼š

**Step 1 â€” é€‰æ‹©è§’è‰²ï¼ˆç½‘æ ¼å¡ç‰‡ï¼‰ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€‰æ‹© AI åŠ©æ‰‹                          â”‚
â”‚                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [Avatar] â”‚ â”‚ [Avatar] â”‚ â”‚ [Avatar] â”‚ â”‚
â”‚ â”‚ ç³»ç»Ÿç®¡ç† â”‚ â”‚ é‡‘èä¸“å®¶ â”‚ â”‚ æ³•åŠ¡ä¸“å®¶ â”‚ â”‚
â”‚ â”‚ ä¸“å®¶     â”‚ â”‚          â”‚ â”‚          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [Avatar] â”‚ â”‚ [Avatar] â”‚ â”‚  [ï¼‹]   â”‚ â”‚
â”‚ â”‚ ç¼–ç¨‹åŠ©æ‰‹ â”‚ â”‚ å†™ä½œåŠ©æ‰‹ â”‚ â”‚ è‡ªå®šä¹‰  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Step 2 â€” ç¡®è®¤é…ç½®ï¼ˆå¯é€‰å±•å¼€é«˜çº§é€‰é¡¹ï¼‰ï¼š**
- è§’è‰²å¤´åƒ + åç§°ï¼ˆå·²é€‰ï¼‰
- æ¨¡å‹é€‰æ‹©ï¼ˆç»§æ‰¿è§’è‰²é»˜è®¤å€¼ï¼Œå¯è¦†ç›–ï¼‰
- æƒé™æ¨¡å¼
- å·¥ä½œç›®å½•
- é«˜çº§ï¼šè‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯

### Phase 4ï¼šèŠå¤©ç•Œé¢ â€” å¤´åƒä¸æ°”æ³¡

**æ”¹åŠ¨æ–‡ä»¶ï¼š`src/pages/agent/components/agent-chat.tsx`**

å½“å‰æ ·å¼ï¼š
```
                    [è“è‰²æ°”æ³¡] ç”¨æˆ·æ¶ˆæ¯
[ç°è‰²æ°”æ³¡] åŠ©æ‰‹æ¶ˆæ¯
```

æ”¹é€ ä¸ºï¼š
```
                         [ç”¨æˆ·æ¶ˆæ¯] [ç”¨æˆ·å¤´åƒ]
[è§’è‰²å¤´åƒ] [åŠ©æ‰‹æ¶ˆæ¯]
           [è§’è‰²å¤´åƒ] [Streaming...]
```

å…³é”®æ”¹åŠ¨ï¼š
- ç”¨æˆ·æ¶ˆæ¯å³ä¾§æ˜¾ç¤ºç”¨æˆ·å¤´åƒï¼ˆæ¥è‡ª `globalModel`ï¼Œfallback åˆ°é»˜è®¤ NiceAvatarï¼‰
- åŠ©æ‰‹æ¶ˆæ¯å·¦ä¾§æ˜¾ç¤ºè§’è‰²å¤´åƒï¼ˆæ¥è‡ªä¼šè¯ç»‘å®šçš„ Personaï¼‰
- å¤´åƒå°ºå¯¸ 32x32ï¼Œåœ†å½¢
- StreamingDisplay ä¹Ÿæ˜¾ç¤ºè§’è‰²å¤´åƒ
- èŠå¤©é¡¶éƒ¨æ˜¾ç¤ºè§’è‰²åç§° + ç®€ä»‹ï¼ˆæ›¿ä»£çº¯ StatusBarï¼‰

### Phase 5ï¼šè§’è‰²ç®¡ç†é¡µé¢

**æ–°å¢æ–‡ä»¶ï¼š`src/pages/personas/index.tsx`**

åŠŸèƒ½ï¼š
- æŸ¥çœ‹æ‰€æœ‰è§’è‰²ï¼ˆå†…ç½® + è‡ªå®šä¹‰ï¼‰
- åˆ›å»ºè‡ªå®šä¹‰è§’è‰²ï¼š
  - åç§°ã€æè¿°
  - NiceAvatar é…ç½®å™¨ï¼ˆäº¤äº’å¼è°ƒæ•´å‘å‹/çœ¼é•œ/è¡£æœç­‰ï¼‰
  - ç³»ç»Ÿæç¤ºè¯ç¼–è¾‘å™¨
  - é»˜è®¤æ¨¡å‹/æƒé™
- ç¼–è¾‘/åˆ é™¤è‡ªå®šä¹‰è§’è‰²ï¼ˆå†…ç½®è§’è‰²ä¸å¯åˆ é™¤ï¼Œå¯å¤åˆ¶ä¿®æ”¹ï¼‰
- è·¯ç”±ï¼š`#/personas`

### Phase 6ï¼šåç«¯é€‚é…ï¼ˆRustï¼‰

**æ”¹åŠ¨æ–‡ä»¶ï¼š`crates/safeclaw/src/agent/`**

- `POST /api/agent/sessions` è¯·æ±‚ä½“æ–°å¢ `system_prompt?: String` å­—æ®µ
- åˆ›å»ºä¼šè¯æ—¶å°† Persona çš„ systemPrompt æ³¨å…¥åˆ° A3S Code SessionManager
- `AgentProcessInfo` æ–°å¢ `persona_id?: String` å­—æ®µï¼ˆå¯é€‰ï¼Œå‰ç«¯ä¹Ÿå¯çº¯æœ¬åœ°ç®¡ç†ï¼‰
- `PATCH /api/agent/sessions/:id` æ”¯æŒæ›´æ–° `persona_id`

---

## æ–‡ä»¶æ”¹åŠ¨æ¸…å•

```
æ–°å¢ï¼š
  src/typings/persona.ts              â€” Persona ç±»å‹å®šä¹‰
  src/models/persona.model.ts         â€” Persona çŠ¶æ€ + CRUD actions
  src/lib/builtin-personas.ts         â€” 6 ä¸ªå†…ç½®è§’è‰²å®šä¹‰
  src/pages/personas/index.tsx         â€” è§’è‰²ç®¡ç†é¡µé¢
  src/pages/personas/components/
    persona-card.tsx                   â€” è§’è‰²å¡ç‰‡ç»„ä»¶
    persona-editor.tsx                 â€” è§’è‰²ç¼–è¾‘å™¨ï¼ˆå« NiceAvatar é…ç½®å™¨ï¼‰
    avatar-configurator.tsx            â€” NiceAvatar äº¤äº’å¼é…ç½®å™¨

æ”¹åŠ¨ï¼š
  src/models/agent.model.ts           â€” æ–°å¢ sessionPersonas æ˜ å°„
  src/typings/agent.ts                â€” AgentProcessInfo æ‰©å±• persona_id
  src/pages/agent/components/
    agent-session-list.tsx             â€” å¾®ä¿¡é£æ ¼åˆ—è¡¨ï¼ˆå¤´åƒ+é¢„è§ˆ+æ—¶é—´ï¼‰
    agent-chat.tsx                     â€” æ¶ˆæ¯æ°”æ³¡æ·»åŠ å¤´åƒ
    create-session-dialog.tsx          â€” ä¸¤æ­¥åˆ›å»ºï¼ˆé€‰è§’è‰²â†’é…ç½®ï¼‰
  src/pages/agent/index.tsx            â€” ç©ºçŠ¶æ€æ”¹ä¸ºè§’è‰²æ¨è
  src/components/custom/layout.tsx     â€” ä¾§è¾¹æ æ–°å¢"è§’è‰²ç®¡ç†"å…¥å£
  src/lib/agent-api.ts                â€” createSession æ”¯æŒ system_prompt

åç«¯ï¼ˆå¯é€‰ï¼ŒPhase 6ï¼‰ï¼š
  crates/safeclaw/src/agent/api.rs     â€” æ‰©å±• create/update æ¥å£
  crates/safeclaw/src/agent/engine.rs  â€” system_prompt æ³¨å…¥
```

---

## å®æ–½ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | Phase | å·¥ä½œé‡ | è¯´æ˜ |
|--------|-------|--------|------|
| P0 | Phase 1 | å° | æ•°æ®å±‚æ˜¯ä¸€åˆ‡åŸºç¡€ |
| P0 | Phase 2 | ä¸­ | å¾®ä¿¡é£æ ¼åˆ—è¡¨ï¼Œè§†è§‰å†²å‡»æœ€å¤§ |
| P0 | Phase 4 | ä¸­ | èŠå¤©å¤´åƒï¼Œä½“éªŒæå‡æœ€æ˜æ˜¾ |
| P1 | Phase 3 | ä¸­ | è§’è‰²é€‰æ‹©åˆ›å»ºæµç¨‹ |
| P1 | Phase 5 | å¤§ | è§’è‰²ç®¡ç†é¡µé¢ï¼ˆNiceAvatar é…ç½®å™¨è¾ƒå¤æ‚ï¼‰ |
| P2 | Phase 6 | ä¸­ | åç«¯ system_prompt æ³¨å…¥ |

å»ºè®®å…ˆåš Phase 1 â†’ 2 â†’ 4 â†’ 3ï¼Œå¿«é€Ÿçœ‹åˆ°æ•ˆæœã€‚Phase 5 å’Œ 6 å¯ä»¥åç»­è¿­ä»£ã€‚

---

## æŠ€æœ¯è¦ç‚¹

1. `react-nice-avatar` ç”¨æ³•ï¼š
```tsx
import Avatar, { genConfig } from "react-nice-avatar";

// ä» Persona é…ç½®ç”Ÿæˆ
const config = genConfig(persona.avatar);
<Avatar className="w-10 h-10" {...config} />

// æˆ–ç›´æ¥ä¼ é…ç½®
<Avatar className="w-8 h-8" sex="man" hairStyle="mohawk" />
```

2. æœ€åæ¶ˆæ¯é¢„è§ˆï¼šä» `agentModel.state.messages[sessionId]` å–æœ€åä¸€æ¡ï¼Œæˆªæ–­æ˜¾ç¤º

3. ç›¸å¯¹æ—¶é—´ï¼šç”¨å·²æœ‰çš„ `dayjs` é…åˆ `relativeTime` æ’ä»¶

4. æœç´¢è¿‡æ»¤ï¼šçº¯å‰ç«¯ filterï¼Œä¸éœ€è¦åç«¯æ”¯æŒ

5. ä¼šè¯-è§’è‰²æ˜ å°„æŒä¹…åŒ–åœ¨ localStorageï¼Œä¸ç°æœ‰ `sessionNames` æ¨¡å¼ä¸€è‡´
